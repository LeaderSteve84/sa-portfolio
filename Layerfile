# Use an Ubuntu 18.04 base for the staging server
FROM vm/ubuntu:18.04

# Update package list and install necessary dependencies
RUN apt-get update && \
    apt-get install -y python3 python3-pip python3-dev build-essential libssl-dev libffi-dev \
    python3-setuptools curl git mysql-server libmysqlclient-dev

# Install required Python packages from requirements.txt
COPY requirements.txt /root/requirements.txt
RUN pip3 install --no-cache-dir -r /root/requirements.txt

# Start MySQL service and configure the database.
RUN service mysql start && \
    mysql -e "CREATE DATABASE IF NOT EXISTS portfolio_db;" && \
    mysql -e "CREATE USER IF NOT EXISTS 'stephen_adah'@'localhost' IDENTIFIED BY 'shalomsmysql2014';" && \
    mysql -e "GRANT ALL PRIVILEGES ON portfolio_db.* TO 'stephen_adah'@'localhost';" && \
    mysql -e "FLUSH PRIVILEGES;"

# Copy all files in the repository to /root (including Flask app)
COPY . .

# Expose a secure web link on port 5000 for the Flask application
# Start MySQL in the background and run the Flask app
RUN BACKGROUND service mysql start && flask run --host=0.0.0.0 --port=5000
EXPOSE WEBSITE http://localhost:5000
